<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Multi-Stream Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr; height: 100vh; margin: 0; background-color: #f4f4f9; }
        header { grid-column: 1 / -1; padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 20px; }
        #status { font-weight: 500; }
        #current-stream { font-weight: bold; color: #0056b3; }
        #sidebar { background-color: #fff; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        #sidebar h2 { margin-top: 0; }
        #stream-list button { display: block; width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; background-color: #f9f9f9; text-align: left; cursor: pointer; border-radius: 4px; }
        #stream-list button:hover { background-color: #e9e9e9; }
        #stream-list button.active { background-color: #007bff; color: white; border-color: #0056b3; }
        main { background-color: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #stream-image { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <header>
        <div id="status">Đang kết nối tới Hub...</div>
        <div>Đang xem: <span id="current-stream">Không có</span></div>
    </header>
    <aside id="sidebar">
        <h2>Streams Đang Hoạt Động</h2>
        <div id="stream-list">
            <p>Đang chờ danh sách...</p>
        </div>
    </aside>
    <main>
        <img id="stream-image" alt="Vui lòng chọn một stream từ danh sách bên trái" />
    </main>

<script>
    const HUB_URL = 'wss://web-steaming.onrender.com/viewer'; // <<< THAY ĐỔI ĐỊA CHỈ NÀY

    const statusEl = document.getElementById('status');
    const streamListEl = document.getElementById('stream-list');
    const imageEl = document.getElementById('stream-image');
    const currentStreamEl = document.getElementById('current-stream');

    const socket = new WebSocket(HUB_URL);

    function subscribeToStream(sessionId) {
        console.log(`Gửi yêu cầu xem stream: ${sessionId}`);
        socket.send(JSON.stringify({ type: 'SUBSCRIBE', sessionId }));
        currentStreamEl.textContent = sessionId;
        // Cập nhật trạng thái active cho button
        document.querySelectorAll('#stream-list button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.sessionId === sessionId);
        });
    }

    function updateStreamList(sessionIds) {
        streamListEl.innerHTML = ''; // Xóa danh sách cũ
        if (sessionIds.length === 0) {
            streamListEl.innerHTML = '<p>Không có stream nào đang hoạt động.</p>';
            currentStreamEl.textContent = "Không có";
            imageEl.src = '';
            return;
        }
        sessionIds.forEach(id => {
            const button = document.createElement('button');
            button.textContent = id;
            button.dataset.sessionId = id;
            button.onclick = () => subscribeToStream(id);
            streamListEl.appendChild(button);
        });
    }

    socket.onopen = () => {
        statusEl.textContent = 'Đã kết nối tới Hub';
        statusEl.style.color = 'green';
    };

    socket.onmessage = (event) => {
        // Tối ưu: Phân biệt control message (JSON) và image data (binary)
        if (typeof event.data === 'string') {
            const message = JSON.parse(event.data);
            if (message.type === 'SESSIONS_UPDATE') {
                updateStreamList(message.data);
            }
        } else if (event.data instanceof Blob) {
            // Đây là dữ liệu ảnh, hiển thị nó
            const imageUrl = URL.createObjectURL(event.data);
            imageEl.src = imageUrl;
            // Tối ưu bộ nhớ: giải phóng URL cũ sau khi ảnh mới được vẽ
            imageEl.onload = () => URL.revokeObjectURL(imageEl.src);
        }
    };

    socket.onclose = () => {
        statusEl.textContent = 'Đã ngắt kết nối Hub';
        statusEl.style.color = 'red';
        streamListEl.innerHTML = '<p>Mất kết nối.</p>';
    };

    socket.onerror = (err) => {
        console.error('WebSocket Error:', err);
        statusEl.textContent = 'Lỗi kết nối';
        statusEl.style.color = 'red';
    };
</script>
</body>
</html>
